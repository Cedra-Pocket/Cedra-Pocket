1. Luồng chung của một request từ Frontend Mini App

User mở Mini App trong Telegram → Frontend (@telegram-apps/sdk) lấy initData (chuỗi ký từ Telegram).
Frontend gửi initData lên Backend (endpoint /auth/verify hoặc tương tự).
Auth Module (Backend):
Validate initData bằng Bot Token (hàm validateWebAppData).
Nếu hợp lệ → Trích xuất telegram_id → Tìm hoặc tạo User trong DB.
Cấp JWT Access Token → Trả về cho Frontend.
Tất cả các request sau đều phải kèm JWT này.

Các request tiếp theo (lấy danh sách quest, verify quest, claim reward…) đều đi qua API Gateway/Core Backend → Xử lý logic → Trả response.

2. Luồng lấy và hiển thị danh sách Quest

Frontend gọi API /quests (có JWT).
Backend (Quest Module):
Query bảng Quests (lọc theo type, category, active…).
Join với User_Quest_History để biết user đã làm quest nào, status ra sao.
Trả về danh sách quest + trạng thái cá nhân (not_started / pending / completed).


3. Luồng làm nhiệm vụ Social (Web2) – Ví dụ: Follow Twitter hoặc Join Channel Telegram

User bấm nút “Start” trên Frontend → Frontend có thể mở link (Twitter profile, Telegram channel) hoặc countdown nếu cần.
User bấm “Verify” → Frontend gọi API /quests/:id/verify (có JWT).
Backend (Quest Module):
Kiểm tra lịch sử: Nếu đã completed → Reject.
Đọc config (JSONB) của quest để biết cần check gì (VD: twitter_handle, channel_id).
Gọi API bên thứ 3:
Telegram: getChatMember để check user có trong channel/group chưa.
Twitter: Gọi X API hoặc RapidAPI để check follow/like/retweet.

Nếu thành công → Cập nhật User_Quest_History.status = COMPLETED.
Đẩy job vào Redis Queue để xử lý reward (xem phần 5).
Trả response ngay cho Frontend: “Đang kiểm tra…” hoặc “Thành công!”.


4. Luồng làm nhiệm vụ On-chain (Web3) – Ví dụ: Swap hoặc Hold token

User bấm “Verify” trên Frontend → Gọi API /quests/:id/verify.
Backend (Blockchain Observer Module):
Kiểm tra lịch sử → Nếu đang pending hoặc đã completed → Reject.
Cập nhật status tạm thời thành PENDING.
Không query blockchain ngay lập tức (để tránh nghẽn).
Đẩy một job vào Redis Queue với dữ liệu:
user wallet_address
quest config (số lượng token cần hold, contract address, transaction hash nếu cần…)


Worker (background process) lấy job từ Queue:
Dùng cedra-ts-sdk để query blockchain (balanceOf, scan transaction…).
Nếu đạt yêu cầu → Cập nhật DB: status = COMPLETED.
Đẩy job mới vào Queue để trả thưởng (nếu có).
Nếu thất bại → status = FAILED (user có thể thử lại sau).

Frontend có thể poll API hoặc nhận notification từ Bot để cập nhật trạng thái.

5. Luồng trả thưởng (Reward & Payout)
Khi một quest được marked COMPLETED (từ Social hoặc On-chain worker):

Backend tính reward theo reward_type:
Points (off-chain): Cộng trực tiếp vào users.balance_points (transaction DB).
Token/NFT (on-chain):
Đẩy job vào Redis Queue (batch payout).


Payout Worker:
Gom nhiều payout lại (batch) để tối ưu gas và tránh nonce conflict.
Lấy private key từ env/secret manager.
Ký và gửi transaction:
Transfer token từ reward pool.
Hoặc gọi mint NFT badge.

Sau khi tx confirmed → Cập nhật DB (lưu tx hash, mark payout done).
Publish event vào Redis channel “notification”.

Bot Module lắng nghe event → Gửi tin nhắn chúc mừng qua Telegram Bot tới user.

6. Luồng Referral

User A mời User B qua link deep link (t.me/bot?start=ref_XXXX).
User B bấm /start → Bot xử lý payload → Lưu referrer_id vào DB khi tạo user mới.
Khi User B hoàn thành quest và nhận reward → Backend tính hoa hồng (%) → Cộng thêm point/token cho User A (có thể qua cùng payout worker).