<!DOCTYPE html>
<html>
<head>
    <title>Test Telegram Auth</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>üß™ Test Telegram Authentication</h1>
    <div id="status">ƒêang ki·ªÉm tra...</div>
    <div id="result"></div>
    
    <script>
        const tg = window.Telegram.WebApp;
        
        async function testAuth() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            
            try {
                // L·∫•y initData th·∫≠t t·ª´ Telegram
                const initData = tg.initData;
                
                if (!initData) {
                    statusDiv.innerHTML = '‚ùå Kh√¥ng c√≥ initData t·ª´ Telegram';
                    return;
                }
                
                statusDiv.innerHTML = 'üì§ ƒêang g·ª≠i request...';
                
                // G·ª≠i l√™n backend
                const response = await fetch('http://localhost:9999/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: initData
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = '‚úÖ X√°c th·ª±c th√†nh c√¥ng!';
                    resultDiv.innerHTML = `
                        <h3>User Info:</h3>
                        <p><strong>ID:</strong> ${data.user.id}</p>
                        <p><strong>Username:</strong> ${data.user.username}</p>
                        <p><strong>Telegram ID:</strong> ${data.user.telegram_id}</p>
                        <p><strong>Points:</strong> ${data.user.total_points}</p>
                        <p><strong>Rank:</strong> ${data.user.current_rank}</p>
                        <p><strong>Referral Code:</strong> ${data.user.referral_code}</p>
                        <h3>JWT Token:</h3>
                        <textarea style="width:100%;height:100px;">${data.access_token}</textarea>
                    `;
                    
                    // L∆∞u token ƒë·ªÉ test API kh√°c
                    localStorage.setItem('jwt_token', data.access_token);
                    
                } else {
                    statusDiv.innerHTML = '‚ùå X√°c th·ª±c th·∫•t b·∫°i';
                    resultDiv.innerHTML = `<p>Error: ${data.message}</p>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML = '‚ùå L·ªói k·∫øt n·ªëi';
                resultDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            }
        }
        
        // T·ª± ƒë·ªông test khi load
        testAuth();
        
        // Test API v·ªõi JWT token
        async function testProtectedAPI() {
            const token = localStorage.getItem('jwt_token');
            if (!token) {
                alert('Ch∆∞a c√≥ JWT token. H√£y x√°c th·ª±c tr∆∞·ªõc.');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:9999/users/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                alert('Profile API: ' + JSON.stringify(data, null, 2));
                
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
    </script>
    
    <button onclick="testAuth()">üîÑ Test l·∫°i</button>
    <button onclick="testProtectedAPI()">üîí Test Protected API</button>
    
    <h3>üìã H∆∞·ªõng d·∫´n:</h3>
    <ol>
        <li>M·ªü file n√†y trong Telegram Mini App</li>
        <li>Xem k·∫øt qu·∫£ x√°c th·ª±c</li>
        <li>Copy JWT token ƒë·ªÉ test API kh√°c</li>
    </ol>
</body>
</html>